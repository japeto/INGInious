function get_service_name_by_key(t){return all_services[t]}function get_services_names(t=[]){return t.map(t=>get_service_name_by_key(t))}function generate_get_url_plot(t){const e=[t],a=[],n=$("#analytics_username").val(),r=$("#analytics_date").val(),i=$("#analytics_service").val(),o=$("#analytics_course").val();return(n||r||i||o)&&e.push("?"),n&&a.push("username="+n),i&&a.push("service="+i),r&&a.push("start_date="+r),o&&a.push("course_id="+o),e.push(a.join("&")),e.join("")}function on_search(){$('.active > a[data-toggle="tab"]').trigger("shown.bs.tab")}function parse_str_to_date(t){return new Date(t)}const AnalyticsDiagram=function(){function t(){this._cachedPromise=null}return t.prototype.plot=function(){this._plotData()},t.prototype._plotData=function(){throw"Not implemented"},t}();$(function(){const t={"heat-map-tab":new HeatMap,"plot-visits-per-day-tab":new VisitsPerDayChart,"box-plot-tab":new BoxPlot,"radar-plot-tab":new RadarPlot};$('a[data-toggle="tab"]').on("shown.bs.tab",function(e){const a=t[e.target.id];a&&a.plot()}),$('.active > a[data-toggle="tab"]').trigger("shown.bs.tab"),$("#analytics_date_filter").datetimepicker({locale:"en",sideBySide:!0,maxDate:moment(),format:"YYYY-MM-DD"}),$("#analytics_date").val(`${(new Date).getFullYear()}-01-02`),$("#analytics_service").val("")});const BoxPlot=function(){function t(){this.div_id="analytics_box_plot",this.request_url="/api/box_plot_analytics/"}return t.prototype=Object.create(AnalyticsDiagram.prototype),t.prototype._generate_plot_layout=function(){return{title:"Box plot of used services",yaxis:{autorange:!0,showgrid:!0,zeroline:!0,tickmode:"auto",gridcolor:"rgb(255, 255, 255)",gridwidth:1,zerolinecolor:"rgb(255, 255, 255)",zerolinewidth:2},margin:{l:40,r:30,b:80,t:100},paper_bgcolor:"rgb(243, 243, 243)",plot_bgcolor:"rgb(243, 243, 243)",showlegend:!1}},t.prototype._plotData=function(){const t=this;Plotly.d3.json(generate_get_url_plot(t.request_url),function(e,a){const n=a.x_data,r=a.y_data,i=[];for(let t=0;t<n.length;t++){const e={type:"box",y:r[t],name:get_service_name_by_key(n[t]),jitter:.5,whiskerwidth:.2,fillcolor:"cls",marker:{size:2},line:{width:1}};i.push(e)}const o=t._generate_plot_layout();Plotly.newPlot(t.div_id,i,o,{showSendToCloud:!0})})},t}(),HeatMap=function(){function t(){this.div_id="analytics_heat_map_calendar",this._calendar_request="/api/calendar_plot_analytics/",this.color=d3.scale.linear().range(["#ebedf0","#e2e45b","#196127"]).domain([0,.5,1]),this.width=900,this.height=105,this.cellSize=12,this.week_days=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],this.month=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],this.day=d3.time.format("%w"),this.week=d3.time.format("%U"),this.percent=d3.format(".1%"),this.format=d3.time.format("%Y%m%d"),this.start_year=(new Date).getFullYear()}return t.prototype=Object.create(AnalyticsDiagram.prototype),t.prototype.update_year=function(){this.start_year=Number(parse_str_to_date($("#analytics_date").val()).getFullYear())-1,this.start_year||(this.start_year=(new Date).getFullYear()-1)},t.prototype._get_svg=function(){const t=this;const e=d3.select("#"+this.div_id).selectAll("svg").data(d3.range((new Date).getFullYear(),this.start_year,-1)).enter().append("svg").attr("width","100%").attr("data-height","0.5678").attr("viewBox","0 0 900 105").attr("class","RdYlGn").append("g").attr("transform","translate("+(this.width-53*this.cellSize)/2+","+(this.height-7*this.cellSize-1)+")");e.append("text").attr("transform","translate(-38,"+3.5*this.cellSize+")rotate(-90)").style("text-anchor","middle").text(function(t){return t});for(let a=0;a<7;a++)e.append("text").attr("transform","translate(-5,"+this.cellSize*(a+1)+")").style("text-anchor","end").attr("dy","-.25em").text(function(e){return t.week_days[a]});return e.selectAll(".month").data(function(t){return d3.time.months(new Date(t,0,1),new Date(t+1,0,1))}).enter().append("path").attr("class","month").attr("id",function(e,a){return t.month[a]}).attr("d",function(e){const a=new Date(e.getFullYear(),e.getMonth()+1,0),n=+t.day(e),r=+t.week(e),i=+t.day(a),o=+t.week(a);return"M"+(r+1)*t.cellSize+","+n*t.cellSize+"H"+r*t.cellSize+"V"+7*t.cellSize+"H"+o*t.cellSize+"V"+(i+1)*t.cellSize+"H"+(o+1)*t.cellSize+"V0H"+(r+1)*t.cellSize+"Z"}),e.selectAll(".legend").data(t.month).enter().append("g").attr("class","legend").attr("transform",function(t,e){return"translate("+(50*(e+1)+8)+",0)"}).append("text").attr("class",function(e,a){return t.month[a]}).style("text-anchor","end").attr("dy","-.25em").text(function(e,a){return t.month[a]}),e},t.prototype._get_rect=function(){const t=this;return this.update_year(),this._get_svg().selectAll(".day").data(function(t){return d3.time.days(new Date(t,0,1),new Date(t+1,0,1))}).enter().append("rect").attr("class","day").attr("width",this.cellSize).attr("height",this.cellSize).attr("x",function(e){return t.week(e)*t.cellSize}).attr("y",function(e){return t.day(e)*t.cellSize}).attr("fill","#fff").attr("onclick",function(e){return"console.log("+t.week(e)+");"}).datum(this.format)},t.prototype._plotData=function(){const t=this;$("#"+this.div_id).html(""),d3.json(generate_get_url_plot(t._calendar_request),function(e,a){let n=new Date;n.setDate(n.getDate()+1);let r=new Date;r.setFullYear(t.start_year),r.setMonth(0),r.setDate(0),n=n.toISOString().slice(0,10);let i=r.toISOString().slice(0,10);const o=[];for(;i!==n;)i in a?o.push({date:i.replace(/\-/g,""),visits:a[i]}):o.push({date:i.replace(/\-/g,""),visits:0}),(i=new Date(i)).setDate(i.getDate()+1),i=i.toISOString().slice(0,10);const s=d3.max(o,function(t){return t.visits}),l=d3.nest().key(function(t){return t.date}).rollup(function(t){return Math.sqrt(s>0?t[0].visits/s:0)}).map(o);t._get_rect().filter(function(t){return t in l}).attr("fill",function(e){return t.color(l[e])}).attr("data-title",function(t){return t.slice(0,4)+"-"+t.slice(4,6)+"-"+t.slice(6,8)+" visits : "+(a[t.slice(0,4)+"-"+t.slice(4,6)+"-"+t.slice(6,8)]?a[t.slice(0,4)+"-"+t.slice(4,6)+"-"+t.slice(6,8)]:0)}),$("rect").tooltip({container:"body",html:!0,placement:"top"})})},t}(),RadarPlot=function(){function t(){this.div_id="analytics_radar_plot",this._radar_request="/api/radar_plot_analytics/"}return t.prototype=Object.create(AnalyticsDiagram.prototype),t.prototype._plotData=function(){const t=this;Plotly.d3.json(generate_get_url_plot(t._radar_request),function(e,a){const n=a.services,r=a.visits;n.push(n[0]),r.push(r[0]);const i=[{type:"scatterpolar",r:r,theta:get_services_names(n),fill:"toself",name:"Group A"}],o={polar:{radialaxis:{visible:!0,range:[0,Math.max.apply(this,r)]}}};Plotly.newPlot(t.div_id,i,o,{showSendToCloud:!0})})},t}(),VisitsPerDayChart=function(){function t(){this.div_id="analytics_plot_visits_per_day",this._time_series_request="/api/time_series_plot_analytics/"}return t.prototype=Object.create(AnalyticsDiagram.prototype),t.prototype._generate_traces=function(t,e){const a={type:"scatter",mode:"lines",name:"All",x:t.dates,y:t.counts,line:{color:"#17BECF"}},n={},r=d3.scale.linear().domain([0,.5,1]).range(["red","yellow","green"]);let i=Object.keys(e).length;Object.keys(e).forEach((t,a)=>{n[t]={type:"scatter",mode:"lines",name:get_service_name_by_key(t),x:unpack(e[t],"date"),y:unpack(e[t],"visits"),line:{color:r(a*(1/(i-1)))}}});const o=[a];for(let t in n)o.push(n[t]);return o},t.prototype._plotData=function(){const t=this;Plotly.d3.json(generate_get_url_plot(t._time_series_request),function(e,a){const n=a.data_all_services,r=a.data_by_service,i=t._generate_traces(n,r),o=new Date,s=new Date(o.getFullYear(),0,1),l=new Date(o);l.setMonth(l.getMonth()-2);let c={title:"Visits per day",xaxis:{autorange:!0,range:[l.toISOString().slice(0,10),(new Date).toISOString().slice(0,10)],rangeselector:{buttons:[{count:1,label:"1 month",step:"month",stepmode:"backward"},{count:6,label:"6 months",step:"month",stepmode:"backward"},{step:"all"}]},rangeslider:{range:[s,(new Date).toISOString().slice(0,10)]},type:"date"},yaxis:{autorange:!0,type:"linear"}};Plotly.newPlot(t.div_id,i,c,{showSendToCloud:!0})})},t}();function unpack(t,e){return t.map(function(t){return t[e]})}